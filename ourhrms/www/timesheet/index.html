<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Timesheet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>My Timesheet</h2>
        <table class="table table-bordered" id="Timesheettable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Total Hours</th>
                    <th>Tasks Worked On</th>
                </tr>
            </thead>
            <tbody>
                 Timesheet data will be inserted here
           </tbody>
        </table>
        <p id="notimesheetMessage" class="text-danger" style="display: none;">No timesheet found.</p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetchTimesheets();
        });

        async function fetchTimesheets() {
            try {
                let response = await fetch(`/api/resource/Timesheet`, { credentials: "include" });
                let data = await response.json();

                if (!data.data || data.data.length === 0) {
                    document.getElementById("notimesheetMessage").style.display = "block";
                    return;
                }

                document.getElementById("notimesheetMessage").style.display = "none";
                let tableBody = document.querySelector("#Timesheettable tbody");
                tableBody.innerHTML = "";

                for (let ts of data.data) {
                    let details = await fetchTimesheetDetails(ts.name);
                    addRowToTable(ts, details);
                }
            } catch (error) {
                console.error("Error fetching timesheets:", error);
            }
        }

async function fetchTimesheetDetails(timesheetId) {
    try {
        let response = await fetch(`/api/resource/Timesheet/${timesheetId}`, { credentials: "include" });
        let data = await response.json();
        
        console.log("Timesheet Details Response:", data);  // Debugging: View API response
        
        return data.data || {}; // Return fetched timesheet details
    } catch (error) {
        console.error("Error fetching timesheet details:", error);
        return {};
    }
}

function addRowToTable(timesheet, details) {
    let tableBody = document.querySelector("#Timesheettable tbody");

    // Find the correct key for task details
    let taskList = details.tasks || details.timesheet_details || details.tasks_worked_on || [];

    let tasks = "No tasks";
    if (Array.isArray(taskList) && taskList.length > 0) {
        tasks = taskList.map(t => t.task || t.task_name).join(", ");
    }

    let row = `<tr>
        <td>${details.date || "N/A"}</td>
        <td>${details.total_hours || "N/A"}</td>
        <td>${tasks}</td>
        
    </tr>`;
    tableBody.insertAdjacentHTML("beforeend", row);
}
    </script>
</body>
</html>

</body>
</html>